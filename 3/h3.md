# H3
Tehtävänanto: Tero Karvinen, Lari Iso-Anttila, https://terokarvinen.com/sovellusten-hakkerointi/

***
## Tehtävä a
> a) Strings. Lataa ezbin-challenges.zip Aja 'passtr'. Selvitä oikea salasana 'strings' avulla. Selvitä myös lippu. (Ensisijaisesti katsomatta sorsia, jos osaat.)

Ajetaan ja katsotaan mitä edes tapahtuu
```
$ ./passtr
What's the password?
helloworld
Sorry, no bonus.
```

Tarkastellaan `strings` komennolla
```
$ strings passtr | less
...
What's the password?
%19s
sala-hakkeri-321
Yes! That's the password. FLAG{Tero-d75ee66af0a68663f15539ec0f46e3b1}
Sorry, no bonus.
...
```

kokeillaan löytynyttä epäilyttävää merkkijonoa

```
$ ./passtr
What's the password?
sala-hakkeri-321
Yes! That's the password. FLAG{Tero-d75ee66af0a68663f15539ec0f46e3b1}
```

***
## Tehtävä b
> b) Tee passtr.c -ohjelmasta uusi versio, jossa salasana ei näy suoraan sellaisenaan binääristä. Osoita testillä, että salasana ei näy. (Obfuskointi riittää.)

XORataan,[^3] `0xa5` on nyt avain. Pythonilla XORaus yksinkertaisesti näillä[^2]
eväillä.
```python
>>> bytes(c ^ 0xa5 for c in b"sala-hakkeri-321")
b'\xd6\xc4\xc9\xc4\x88\xcd\xc4\xce\xce\xc0\xd7\xcc\x88\x96\x97\x94'
```

VIMillä muutan vain `\ -> 0` ja ulos tulee tavujono

maalaa koko alla oleva rimpsu
```bash
\xd6\xc4\xc9\xc4\x88\xcd\xc4\xce\xce\xc0\xd7\xcc\x88\x96\x97\x94
```

seuraava komento VIMin komentokehotteeseen (: avaa)
```
:'<,'>s/\\/, 0/g
```
englanniksi jotakuinkin "search all `\`, replace with `, 0`, for all occurrences".

ulos tulee alla oleva, poistetaan ekat pari merkkiä
```
0xd6, 0xc4, 0xc9, 0xc4, 0x88, 0xcd, 0xc4, 0xce, 0xce, 0xc0, 0xd7, 0xcc, 0x88, 0x96, 0x97, 0x94
```

Tehdään sama myös lipulle

```python
>>> bytes(c ^ 0xa5 for c in b"FLAG{Tero-d75ee66af0a68663f15539ec0f46e3b1}")
b'\xe3\xe9\xe4\xe2\xde\xf1\xc0\xd7\xca\x88\xc1\x92\x90\xc0\xc0\x93\x93\xc4\xc3
\x95\xc4\x93\x9d\x93\x93\x96\xc3\x94\x90\x90\x96\x9c\xc0\xc6\x95\xc3\x91\x93\xc0\x96\xc7\x94\xd8'
```

Enää ei tarvitse kuin vain maalata teksti ja :, jonka jälkeen nuoli ylöspäin ja enter. Nyt VIM
toistaa edellä tehdyn komennon
```
0xe3, 0xe9, 0xe4, 0xe2, 0xde, 0xf1, 0xc0, 0xd7, 0xca, 0x88, 0xc1, 0x92, 0x90, 0xc0, 0xc0, 0x93,
0x93, 0xc4, 0xc3, 0x95, 0xc4, 0x93, 0x9d, 0x93, 0x93, 0x96, 0xc3, 0x94, 0x90, 0x90, 0x96, 0x9c,
0xc0, 0xc6, 0x95, 0xc3, 0x91, 0x93, 0xc0, 0x96, 0xc7, 0x94, 0xd8
```

Nyt muokkaamalla `passtr.c`:tä siten, että salasana ja lippu on piilotettu näihin
XORattuihin tavujonoihin. Kun salasana on annettu, puretaan tallennettu salasana ja
verrataan sitä. Saman voisi tehdä myös niin päin, että XORataan annettu salasana ja
verrataan sitä tallennettuun muotoon.

Tämän jälkeen, jos salasana on oikein puretaan myös lippu.

Ohessa vielä korjattu sorsa
```c
// passtr - a simple static analysis warm up exercise - modified by p-lemonish
// Copyright 2024 Tero Karvinen https://TeroKarvinen.com

#include <stdio.h>
#include <string.h>

int main() {
  char password[20];
  unsigned char feikkisalis[] = {
      0xd6, 0xc4, 0xc9, 0xc4, 0x88, 0xcd, 0xc4, 0xce, 0xce, 0xc0, 0xd7,
      0xcc, 0x88, 0x96, 0x97, 0x94
  };
  unsigned char feikkilippu[] = {
      0xe3, 0xe9, 0xe4, 0xe2, 0xde, 0xf1, 0xc0, 0xd7, 0xca, 0x88, 0xc1,
      0x92, 0x90, 0xc0, 0xc0, 0x93, 0x93, 0xc4, 0xc3, 0x95, 0xc4, 0x93,
      0x9d, 0x93, 0x93, 0x96, 0xc3, 0x94, 0x90, 0x90, 0x96, 0x9c, 0xc0,
      0xc6, 0x95, 0xc3, 0x91, 0x93, 0xc0, 0x96, 0xc7, 0x94, 0xd8};

  unsigned char avain = 0xa5;

  printf("What's the password?\n");
  scanf("%19s", password);

  size_t len = sizeof(feikkisalis);
  char salis[64];
  for (int i = 0; i < len; i++) {
    salis[i] = feikkisalis[i] ^ avain;
  }
  salis[len] = '\0';

  if (0 == strcmp(password, salis)) {
    printf("Yes! That's the password. ");
    len = sizeof(feikkilippu);
    char lippu[64];
    for (int i = 0; i < len; i++) {
      lippu[i] = feikkilippu[i] ^ avain;
    }
    lippu[len] = '\0';
    printf("%s\n", lippu);
  } else {
    printf("Sorry, no bonus.\n");
  }
  return 0;
}
```

```
$ make
gcc passtr.c -o passtr
```

nyt strings katsomalla

```
...
PTE1
u+UH
What's the password?
%19s
Yes! That's the password.
Sorry, no bonus.
;*3$"
GCC: (Debian 14.2.0-19) 14.2.0
...
```

Ja ohjelman ajo toimii edelleen samalla tavalla.

```
$ ./passtr
What's the password?
en tiedä
Sorry, no bonus.

$ ./passtr
What's the password?
sala-hakkeri-321
Yes! That's the password. FLAG{Tero-d75ee66af0a68663f15539ec0f46e3b1}
```

***
## Tehtävä c
>c) Packd. Aja 'packd' paketista ezbin-challenges.zip. Mikä on salasana? Mikä on lippu?

Ajetaan ja tarkastellaan `strings`:llä

```bash
$ ./packd
What's the password?
hello world
Sorry, no bonus.
```

```
...
 CrvP
PTE1
u+UH
What's the password?
piilos-An
Yes! T,
W. FLAG{Tero-0e3bed0a89d88
51da933c64fefad
S1ry
, no bonus.
;*3$F
NDeo2
...
```

Ajoin itse `gdb`:llä binääriä askel kerrallaan. Laitoin salasanan inputiksi `helloworld`
ja sitten steppailin eteenpäin, kunnes ohjelma vertasi salasanoja suoraan keskenään.
Tämä voitaisiin välttää jos ei tehtäisi suoraan `strcmp`:tä, luulisin.

```
─────────────────────────[ REGISTERS / show-flags off / show-compact-regs off ]──────────────────────────
 RAX  0x800ee
 RBX  0x7fff3d1ae040 —▸ 0x7fff3d1ae198 —▸ 0x7fff3d1b00a2 ◂— 0x646b6361702f2e /* './packd' */
 RCX  0
 RDX  0
 RDI  0x7fff3d1ae060 ◂— 'helloworld'
 RSI  0x7f5d3f981022 ◂— 'piilos-AnAnAs'
 R8   0
 R9   0x13
 R10  0x7f5d3f8bc8e0 ◂— 0x2000200020002
 R11  0xa
 R12  0
 R13  0x7fff3d1ae1a8 —▸ 0x7fff3d1ae51d ◂— '   =/home/kali/apphacking/3/challenges/packd/packd'
 R14  0x7f5d3f976000 —▸ 0x7f5d3f977310 —▸ 0x7f5d3f97f000 ◂— 0x10102464c457f
 R15  0x7f5d3f982dd8 —▸ 0x7f5d3f980110 ◂— endbr64
 RBP  0x7fff3d1ae080 ◂— 1
 RSP  0x7fff3d1adc80 —▸ 0x7fff3d1ae060 ◂— 'helloworld'
*RIP  0x7f5d3f952660 ◂— mov qword ptr [rsp + 0x268], rdx
```

Testataan salasanaa `piilos-AnAnAs`:
```
$ ./packd
What's the password?
piilos-AnAnAs
Yes! That's the password. FLAG{Tero-0e3bed0a89d8851da933c64fefad4ff2}
```
Toinen, nopeampi tapa, koska tämä ohjelma tulostaa asioita, on vaan suoraan
etsiä tunnettuja merkkijonoja. Ajetaan ohjelma käyntiin

```
$ ./packd
What's the password?

# Etsitään ohjelman PID
$ ps -aux | grep packd
kali     1294865  0.0  0.0   2564  1452 pts/10   S+   11:17   0:00 ./packd

# Kiinnitetään pwndbg/GDB
$ gdb -p 1294865
```

pwndbg:llä voidaan etsiä, missä kohtaa muistia on ladattu tunnetut merkkijonot.

pwndbg on GDB:n python-pohjainen lisäosa[^1]. Oikeasti tosi hyödyllinen työkalu,
johon rakennettu valmiiksi toimintoja GDB:n päälle. Esim. tämä tuleva `search`.

```
pwndbg> search -t string "Sorry, no bonus."
Searching for string: b'Sorry, no bonus.\x00'
[anon_7f7c2a2ff] 0x7f7c2a2ff076 'Sorry, no bonus.'
```

Voisi myös etsiä "What's the password", jos ohjelmaa ajaa vasta ensimmäistä kertaa.

etstiään tuosta muistilokerosta käsin `hexdump`:lla

```
pwndbg> hexdump anon_7f7c2a2ff
+0000 0x7f7c2a2ff000  01 00 02 00 00 00 00 00  57 68 61 74 27 73 20 74  │........│What's.t│
+0010 0x7f7c2a2ff010  68 65 20 70 61 73 73 77  6f 72 64 3f 00 25 31 39  │he.passw│ord?.%19│
+0020 0x7f7c2a2ff020  73 00 70 69 69 6c 6f 73  2d 41 6e 41 6e 41 73 00  │s.piilos│-AnAnAs.│
+0030 0x7f7c2a2ff030  59 65 73 21 20 54 68 61  74 27 73 20 74 68 65 20  │Yes!.Tha│t's.the.│
pwndbg>
+0040 0x7f7c2a2ff040  70 61 73 73 77 6f 72 64  2e 20 46 4c 41 47 7b 54  │password│..FLAG{T│
+0050 0x7f7c2a2ff050  65 72 6f 2d 30 65 33 62  65 64 30 61 38 39 64 38  │ero-0e3b│ed0a89d8│
+0060 0x7f7c2a2ff060  38 35 31 64 61 39 33 33  63 36 34 66 65 66 61 64  │851da933│c64fefad│
+0070 0x7f7c2a2ff070  34 66 66 32 7d 00 53 6f  72 72 79 2c 20 6e 6f 20  │4ff2}.So│rry,.no.│
pwndbg>
+0080 0x7f7c2a2ff080  62 6f 6e 75 73 2e 00 00  01 1b 03 3b 2c 00 00 00  │bonus...│...;,...│
+0090 0x7f7c2a2ff090  04 00 00 00 98 ef ff ff  78 00 00 00 d8 ef ff ff  │........│x.......│
+00a0 0x7f7c2a2ff0a0  a0 00 00 00 e8 ef ff ff  48 00 00 00 d1 f0 ff ff  │........│H.......│
+00b0 0x7f7c2a2ff0b0  b8 00 00 00 00 00 00 00  14 00 00 00 00 00 00 00  │........│........│
```

Siellä lukeekin `piilos-AnAnAs`. Tämähän oli helpomaa kuin odotin, koska
yleensä salasanat ladataan muistiin vasta, kun tarkastelun aika. Nyt ne olivat
ladattuina muistiin heti käynnistyttyä.

# Lähteet
[^1]: pwndbg, https://github.com/pwndbg/pwndbg
[^2]: how to do bitwise exclusive or of two strings in python?, https://stackoverflow.com/questions/2612720/how-to-do-bitwise-exclusive-or-of-two-strings-in-python
[^3]: XOR-cipher, Wikipedia, https://en.wikipedia.org/wiki/XOR_cipher
